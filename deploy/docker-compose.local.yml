# ══════════════════════════════════════════════════════════════════════════════
#  Local Development Overlay
# ══════════════════════════════════════════════════════════════════════════════
#
#  Builds from source, exposes all ports to host, adds Seq for logging,
#  and mounts frontend source for HMR.
#
#    ./deploy/up.sh local up -d --build
#
# ══════════════════════════════════════════════════════════════════════════════

name: test-local

services:
  api:
    build:
      context: ./src/backend
      dockerfile: Test.WebApi/Dockerfile
      args:
        STRIP_DEV_CONFIG: "false"
    env_file: deploy/envs/local.env
    environment:
      ASPNETCORE_ENVIRONMENT: ${ASPNETCORE_ENVIRONMENT:-Development}
      Serilog__WriteTo__0__Name: Seq
      Serilog__WriteTo__0__Args__serverUrl: http://seq:80
    ports:
      - "${API_PORT:-13002}:8080"
    depends_on:
      seq:
        condition: service_started

  seq:
    image: datalust/seq:2025
    restart: unless-stopped
    networks:
      - backend
    environment:
      ACCEPT_EULA: "Y"
      SEQ_FIRSTRUN_NOAUTHENTICATION: "true"
    ports:
      - "${SEQ_PORT:-13008}:80"
    volumes:
      - seq_data:/data

  redis:
    ports:
      - "${REDIS_PORT:-13006}:6379"

  db:
    ports:
      - "${DB_PORT:-13004}:5432"

  frontend:
    build:
      context: ./src/frontend
      dockerfile: Dockerfile.local
    volumes:
      - ./src/frontend:/app
      - frontend_node_modules:/app/node_modules
    ports:
      - "${FRONTEND_PORT:-13000}:5173"
    healthcheck:
      test: ["CMD", "node", "-e", "fetch('http://localhost:5173').then(r=>{process.exit(r.ok?0:1)}).catch(()=>process.exit(1))"]

volumes:
  seq_data:
  frontend_node_modules:
