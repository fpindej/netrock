# ══════════════════════════════════════════════════════════════════════════════
#  Local Development Overlay
# ══════════════════════════════════════════════════════════════════════════════
#
#  Builds from source, exposes all ports to host, adds Seq for logging,
#  and mounts frontend source for HMR.
#
#    ./deploy/up.sh local up -d --build
#
# ══════════════════════════════════════════════════════════════════════════════

name: {INIT_PROJECT_SLUG}-local

services:
  api:
    build:
      context: ./src/backend
      dockerfile: MyProject.WebApi/Dockerfile
      args:
        STRIP_DEV_CONFIG: "false"
    env_file:
      - deploy/envs/local/api.env
      - deploy/envs/local/seed.env
    environment:
      ASPNETCORE_ENVIRONMENT: ${ASPNETCORE_ENVIRONMENT:-Development}
      Serilog__WriteTo__0__Name: Seq
      Serilog__WriteTo__0__Args__serverUrl: http://seq:80
    ports:
      - "${API_PORT:-{INIT_API_PORT}}:8080"
    depends_on:
      seq:
        condition: service_started

  seq:
    image: datalust/seq:2025
    restart: unless-stopped
    networks:
      - backend
    environment:
      ACCEPT_EULA: "Y"
      SEQ_FIRSTRUN_NOAUTHENTICATION: "true"
    ports:
      - "${SEQ_PORT:-{INIT_SEQ_PORT}}:80"
    volumes:
      - seq_data:/data

  storage:
    ports:
      - "${STORAGE_PORT:-{INIT_STORAGE_PORT}}:9000"
      - "${STORAGE_CONSOLE_PORT:-{INIT_STORAGE_CONSOLE_PORT}}:9001"

  redis:
    ports:
      - "${REDIS_PORT:-{INIT_REDIS_PORT}}:6379"

  db:
    ports:
      - "${DB_PORT:-{INIT_DB_PORT}}:5432"

  frontend:
    build:
      context: ./src/frontend
      dockerfile: Dockerfile.local
    volumes:
      - ./src/frontend:/app
      - frontend_node_modules:/app/node_modules
    ports:
      - "${FRONTEND_PORT:-{INIT_FRONTEND_PORT}}:5173"
    healthcheck:
      test: ["CMD", "node", "-e", "fetch('http://localhost:5173').then(r=>{process.exit(r.ok?0:1)}).catch(()=>process.exit(1))"]

volumes:
  seq_data:
  frontend_node_modules:
